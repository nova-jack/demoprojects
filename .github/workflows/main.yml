name: Install Kubectl for OKE

on:
  push:
    branches:
      - main

jobs:
  install-kubectl:
    runs-on: ubuntu-latest
    env:
      OCI_CLI_USER: ${{ secrets.OCI_CLI_USER }}
      OCI_CLI_TENANCY: ${{ secrets.OCI_CLI_TENANCY }}
      OCI_CLI_FINGERPRINT: ${{ secrets.OCI_CLI_FINGERPRINT }}
      OCI_CLI_REGION: ${{ secrets.OCI_CLI_REGION }}

    steps:
      - name: Generate OCI CLI Key Content
        id: generate-key
        run: |
          # Add your logic here to generate or retrieve the OCI CLI key content
          # For example, you might create a new key pair using openssl
          openssl genpkey -algorithm RSA -out private_key.pem
          openssl rsa -pubout -in private_key.pem -out public_key.pem
          
          # Set the key content as an output variable
          echo "::set-output name=oci_cli_key_content::$(cat private_key.pem)"

      - name: Configure Kubectl
        uses: oracle-actions/configure-kubectl-oke@v1.3.2
        id: configure-kubectl
        with:
          cluster: ${{ secrets.OKE_CLUSTER_OCID }}
          oci-cli-key-content: ${{ steps.generate-key.outputs.oci_cli_key_content }}

      - name: Run Kubectl
        run: kubectl get nodes -A
